# Human Face Match Tests

Test solution for face matching of descriptors generated by `Human` library  
(in reality any other descriptor can also be used as long as descriptors in database and generated descriptor are of the same length)

All implementations are independent of the original library  
(e.g., does not require `human` and assumes descriptors are already generated)

<br>

## Variations

- Pure JS solution using match loop and similarity algorithm
- Hybrid solution using JS match loop and WASM similarity algorithm
- Pure WASM solution using WASM match loop and WASM similarity algorithm

<br>

## Notes

### Descriptors

- Descriptor generated by `Human` can be reduced in dimensionality by 2x-32x  
  (e.g. from 1024-element array all the way to 32-element array)  
  see `match.js:reduce` method currently uses pca, but can use different methods:  
  <https://en.wikipedia.org/wiki/Dimensionality_reduction>  
  <https://en.wikipedia.org/wiki/Nonlinear_dimensionality_reduction>  
- High the reduction, higher the precission loss  
  `match` result is similar, but individual `similarity` resutls are very different
- Reduction is CPU intensive and should be done on original face db insert
- Descriptor can also be normalized and stored with minimum loss of detail as `uint8` array  
  and reconstructed to `f32` array on load thus resulting in size savings is 4x
- Combining uint8 and reduced dimensionality would allow processing of db with >10M records in a single pass

### WASM

- Written in AssemblyScript
- Uses `f32` instead of default `f64`
- `NativeMathF` stdlib is faster than `MathJS` import lib by 25%, but `MathJS` based solution is smaller  
- Built using shared memory, could be used instead of building the array inside WASM instance
- built using multi-threading, instead of having NodeJS worker thread pool, we could have WASM threading  
- could be further optimized to use `SIMD` 128bit operations instead of `f32` thus reducing similarity loop by 4x

<br>

## Build

> node build.js

```js
2021-09-30 08:17:54 INFO:  AssemblyScript version 0.19.16
2021-09-30 08:18:00 DATA:  ASC: { input: 'assembly/human-match.ts', output: 'dist/human-match.wasm', size: 8431 }
```

*asc compile options are inside `build.js`*

<br>

## Test

> node match.js

```js
2021-09-30 14:49:47 INFO:  wasm: { file: 'dist/human-match.wasm', exports: [ 'features', 'register', 'reset', 'distance', 'match' ] }
2021-09-30 14:49:47 INFO:  wasm features: { target: '32bit', optimize: 3, shrink: 0, simd: true, shmem: true, threads: true }
2021-09-30 14:49:48 TIMED: 1,461 ms db load: { records: 22500 }
2021-09-30 14:49:49 TIMED: 308 ms db unpack: { records: 22500, bytes: 134217728, reduce: 1, descriptor: 1024 }
2021-09-30 14:49:49 TIMED: 66 ms match { type: 'javascript ' } { index: 11, name: 'ai', similarity: 99.2, distance: 0.7729938550855369 }
2021-09-30 14:49:49 TIMED: 594 ms match { type: 'hybrid wasm' } { index: 11, name: 'ai', similarity: 99.2, distance: 0.7729937118284379 }
2021-09-30 14:49:49 TIMED: 145 ms match { type: 'pure wasm  ' } { index: 11, name: 'ai', similarity: 99.2, distance: 0.7729936838150024 }
```

> reference implementation in `human`

```js
2021-09-30 08:16:13 TIMED: 686 ms match { type: 'original   ' } { name: 'ai', similarity: 99.2, distance: 0.7729938550855369 }
```

## Conclusions

- round-trip to WASM instance and back is a killer, so hybrid option is a no-go.
- Updated JS implementation is 10x faster than original one
- Updated JS is faster than WASM showing how much optimizations is present in JS engine
